var __awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{d(n.next(t))}catch(t){o(t)}}function h(t){try{d(n.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}d((n=n.apply(t,e||[])).next())}))};import{assignProps}from"@just4/util/object";import{toArray,mergeArray}from"@just4/util/array";import{$}from"@just4/dom/index";import{EventEmitter}from"eventemitter3";import{debounce}from"./internal/util";import{RenderPosition}from"./types";import{ItemList}from"./item-list";import{VirtualListEvent}from"./events";export class VirtualList{constructor(t){this._itemList=[],this._itemNodes=[],this._stateFlags={renderBoundary:[],renderEmpty:[],renderError:[],renderLoading:[]},this._stateNodes={renderBoundary:[],renderEmpty:[],renderError:[],renderLoading:[]},this.__checkPositionCounter=0,this._eventEmitter=new EventEmitter,this._container=$(t.container),this._options=assignProps({},t),this.items=new ItemList((t=>this._itemList[t]),(()=>this._itemList.length)),setTimeout((()=>{this._init()}),0)}setOption(t,e){if("container"===t)throw new Error("Container cannot be changed.");if("defaultView"===t)throw new Error("Default view cannot be changed.");this._options[t]=e}get _prefetchDistance(){var t;return null!==(t=this._options.prefetchDistance)&&void 0!==t?t:2}get _maxItemCount(){var t;return null!==(t=this._options.maxItemCount)&&void 0!==t?t:100}destroy(t){this._eventEmitter.removeAllListeners(),this._onScrollFn&&this._container.off("scroll",this._onScrollFn),this._onClickFn&&this._container.off("click",this._onClickFn),t&&this._container.empty()}scrollToHead(){this._container.scrollTop(0)}scrollToFoot(){const t=this._container.get(0);this._container.scrollTop(t.scrollHeight-t.clientHeight)}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=this._options.renderer;this._setAndRenderState("renderLoading",!0,RenderPosition.Main);let e,i=null;try{i=yield this._options.dataSource.loadInitialData()}catch(t){e=t}finally{this._setAndRenderState("renderLoading",!1,RenderPosition.Main)}if(e||!i)return void this._setAndRenderState("renderError",!0,RenderPosition.Main,e);const n=i.data;if(null==n||!n.length)return this._stateFlags.renderBoundary[RenderPosition.Head]=this._stateFlags.renderBoundary[RenderPosition.Foot]=!0,void this._setAndRenderState("renderEmpty",!0,RenderPosition.Main);mergeArray(this._itemList,n);const s=t.renderItems(n,this);mergeArray(this._itemNodes,s),this._container.append(s),!0===i.reachedHeadBoundary&&this._keepView((()=>{this._setAndRenderState("renderBoundary",!0,RenderPosition.Head)})),!0===i.reachedFootBoundary&&this._setAndRenderState("renderBoundary",!0,RenderPosition.Foot),"foot"===this._options.defaultView&&this.scrollToFoot(),this._listenScroll(),this._listenClick()}))}refresh(){return __awaiter(this,void 0,void 0,(function*(){this.destroy(!0),yield this._init()}))}_checkPosition(t){if(t&&(this.__checkPositionCounterResetTimer&&clearTimeout(this.__checkPositionCounterResetTimer),this.__checkPositionCounterResetTimer=window.setTimeout((()=>{this.__checkPositionCounter=0}),1e3),this.__checkPositionCounter++>10))return;const e=this._container,i=e.scrollTop(),n=e.prop("scrollHeight"),s=e.prop("clientHeight"),o=this._prefetchDistance*s;i+s+o>=n&&this._fetchNext(),i<=o&&this._fetchPrevious()}checkPosition(){this._checkPosition(!1)}_listenScroll(){this._onScrollFn=debounce(this.checkPosition.bind(this),100),this._container.on("scroll",this._onScrollFn),this.checkPosition()}_onClick(t){const e=t.target;if(!e)return;let i;i=e.parentElement===this._container.get(0)?e:$(e).parentsUntil(this._container.get(0)).get(-1);let n=-1;for(let t=this._itemNodes.length-1;t>=0;t--)if(this._itemNodes[t]===i){n=t;break}if(-1!==n){const e={domEvent:t,itemNode:this._itemNodes[n],itemData:assignProps({},this._itemList[n])};this._eventEmitter.emit(VirtualListEvent.ITEM_CLICK,e)}}_listenClick(){this._onClickFn=this._onClick.bind(this),this._container.on("click",this._onClickFn)}_setAndRenderState(t,e,i,n){if(this._stateFlags[t][i]===e)return;this._stateFlags[t][i]=e;const s=this._stateNodes[t];if(e){const e=this._options.renderer,o=e[t];if(o){const t=s[i]=o.call(e,i,this,n);t&&(i===RenderPosition.Head?this._container.prepend(t):this._container.append(t))}}else{const t=s[i];t&&(s[i]=null,$(t).remove())}}_keepView(t){const e=this._container.get(0),i=e.scrollTop,n=e.getBoundingClientRect().top;let s,o=0,r=-1;for(;(s=this._itemNodes[++r])&&(s=this._itemNodes[r],o=s.getBoundingClientRect().top,!(o-n>=0)););if(t(),!s)return;const h=(s.parentNode?s.getBoundingClientRect().top:0)-o;h&&this._container.scrollTop(i+h)}_fetch(t,e,i){return __awaiter(this,void 0,void 0,(function*(){const n=this._stateFlags;if(this.__isLoading||n.renderBoundary[t]||n.renderError[t])return;let s,o;this._keepView((()=>{this._setAndRenderState("renderLoading",!0,t)})),this.__isLoading=!0;try{s=yield e()}catch(t){o=t}finally{this.__isLoading=!1}o?this._keepView((()=>{this._setAndRenderState("renderLoading",!1,t),this._setAndRenderState("renderError",!0,t)})):null!=s&&s.length?(i(s),setTimeout((()=>{this._checkPosition(!0)}),0)):this._keepView((()=>{this._setAndRenderState("renderLoading",!1,t),this._setAndRenderState("renderBoundary",!0,t)}))}))}_updateAndRenderPrevious(t){const e=this._itemList.length+t.length-this._maxItemCount;if(e>0){const t={itemList:this._itemList.splice(this._itemList.length-e,e),itemNodes:$(this._itemNodes.splice(this._itemNodes.length-e,e)).remove()};this._eventEmitter.emit(VirtualListEvent.ITEM_REMOVE,t),this._setAndRenderState("renderBoundary",!1,RenderPosition.Foot)}this._itemList=t.concat(this._itemList);const i=this._options.renderer.renderItems(t,this);this._keepView((()=>{this._itemNodes.length?$(this._itemNodes[0]).before(i):this._container.append(i)})),this._itemNodes=toArray(i).concat(this._itemNodes)}_fetchPrevious(){return __awaiter(this,void 0,void 0,(function*(){return this._fetch(RenderPosition.Head,(()=>this._options.dataSource.loadPreviousData(this._itemList[0][this._options.itemKey])),this._updateAndRenderPrevious.bind(this))}))}_updateAndRenderNext(t){const e=this._itemList.length+t.length-this._maxItemCount;if(e>0){const t=this._itemList.splice(0,e),i=$(this._itemNodes.splice(0,e));this._keepView((()=>{this._setAndRenderState("renderBoundary",!1,RenderPosition.Head),i.remove()}));const n={itemList:t,itemNodes:i};this._eventEmitter.emit(VirtualListEvent.ITEM_REMOVE,n)}mergeArray(this._itemList,t);const i=this._options.renderer.renderItems(t,this);if(this._itemNodes.length){$(this._itemNodes[this._itemNodes.length-1]).after(i)}else this._container.append(i);mergeArray(this._itemNodes,i)}_fetchNext(){return __awaiter(this,void 0,void 0,(function*(){return this._fetch(RenderPosition.Foot,(()=>{const t=this._itemList[this._itemList.length-1];return this._options.dataSource.loadNextData(t[this._options.itemKey])}),this._updateAndRenderNext.bind(this))}))}_findItemIndex(t){const e=this._options.itemKey;let i=-1;for(let n=this._itemList.length-1;n>=0;n--)if(this._itemList[n][e]===t){i=n;break}return i}updateItem(t){const e=this._findItemIndex(t[this._options.itemKey]);if(-1===e)return!1;this._itemList[e]=t;const i=this._options.renderer.renderItems([t],this)[0];return this._keepView((()=>{$(this._itemNodes[e]).replaceWith(i)})),this._itemNodes[e]=i,!0}removeItem(t){const e=this._findItemIndex(t);if(-1!==e){const t=this._itemList.splice(e,1),i=$(this._itemNodes.splice(e,1));this._keepView((()=>{i.remove()}));const n={itemList:t,itemNodes:i};return this._eventEmitter.emit(VirtualListEvent.ITEM_REMOVE,n),t[0]}}_shouldKeepDefaultView(){if(!this._itemNodes.length)return!1;const t=this._container.get(0),e=t.getBoundingClientRect().top,i=t.clientHeight;if("head"===this._options.defaultView){const t=this._itemNodes[0].getBoundingClientRect().top-e;return t>=0||-t<=.1*i}if("foot"===this._options.defaultView){const t=this._itemNodes[this._itemNodes.length-1].getBoundingClientRect().bottom-e;return t<i||t-i<=.1*i}return!1}addBoundaryItems(t,e,i){if(!0!==this._stateFlags.renderBoundary[e])return!1;const n=this._shouldKeepDefaultView();if(e===RenderPosition.Head)this._updateAndRenderPrevious(t);else{if(e!==RenderPosition.Foot)throw new Error('"position" must be "RenderPosition.Head" or "RenderPosition.Foot".');this._updateAndRenderNext(t)}if(i&&n)switch(this._options.defaultView){case"head":this.scrollToHead();break;case"foot":this.scrollToFoot()}return!0}resetBoundaryState(t){this._keepView((()=>{this._setAndRenderState("renderBoundary",!1,t)}))}retryFetch(t){(this._stateFlags.renderError[t]||this._stateFlags.renderBoundary[t])&&(this._keepView((()=>{this._setAndRenderState("renderError",!1,t),this._setAndRenderState("renderBoundary",!1,t),this._setAndRenderState("renderLoading",!0,t)})),t===RenderPosition.Head?this._fetchPrevious():t===RenderPosition.Foot&&this._fetchNext())}on(t,e,i){this._eventEmitter.on(t,e,i)}off(t,e,i){this._eventEmitter.off(t,e,i)}}