var __awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function d(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,d)}h((n=n.apply(t,e||[])).next())}))};import{assignProps}from"@just4/util/object";import{toArray,mergeArray}from"@just4/util/array";import{$}from"@just4/dom/index";import{debounce}from"./internal/util";import{RenderPosition}from"./types";export class VirtualList{constructor(t){var e,i;this._itemList=[],this._itemNodes=[],this._stateFlags={renderBoundary:[],renderEmpty:[],renderError:[],renderLoading:[]},this._stateNodes={renderBoundary:[],renderEmpty:[],renderError:[],renderLoading:[]},this.__checkPositionCounter=0,this._container=$(t.container),this._options=Object.freeze(assignProps({},t)),this._prefetchDistance=null!==(e=this._options.prefetchDistance)&&void 0!==e?e:2,this._maxItemCount=null!==(i=this._options.maxItemCount)&&void 0!==i?i:100,this._init()}destroy(t){this._onScrollFn&&this._container.off("scroll",this._onScrollFn),this._onClickFn&&this._container.off("click",this._onClickFn),t&&this._container.empty()}scrollToHead(){this._container.scrollTop(0)}scrollToFoot(){const t=this._container.get(0);this._container.scrollTop(t.scrollHeight-t.clientHeight)}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=this._options.renderer;this._setAndRenderState("renderLoading",!0,RenderPosition.Main);let e,i=null;try{i=yield this._options.dataSource.loadInitialData()}catch(t){e=t}finally{this._setAndRenderState("renderLoading",!1,RenderPosition.Main)}if(e||!i)return void this._setAndRenderState("renderError",!0,RenderPosition.Main,e);const n=i.data;if(null==n||!n.length)return this._stateFlags.renderBoundary[RenderPosition.Head]=this._stateFlags.renderBoundary[RenderPosition.Foot]=!0,void this._setAndRenderState("renderEmpty",!0,RenderPosition.Main);mergeArray(this._itemList,n);const s=t.renderItems(n);mergeArray(this._itemNodes,s),this._container.append(s),!0===i.reachedHeadBoundary&&this._keepView((()=>{this._setAndRenderState("renderBoundary",!0,RenderPosition.Head)})),!0===i.reachedFootBoundary&&this._setAndRenderState("renderBoundary",!0,RenderPosition.Foot),"foot"===this._options.defaultView&&this.scrollToFoot(),this._listenScroll(),this._listenClick()}))}refresh(){return __awaiter(this,void 0,void 0,(function*(){this.destroy(!0),yield this._init()}))}_checkPosition(t){if(t&&(this.__checkPositionCounterResetTimer&&clearTimeout(this.__checkPositionCounterResetTimer),this.__checkPositionCounterResetTimer=window.setTimeout((()=>{this.__checkPositionCounter=0}),1e3),this.__checkPositionCounter++>10))return;const e=this._container,i=e.scrollTop(),n=e.prop("scrollHeight"),s=e.prop("clientHeight"),o=this._prefetchDistance*s;i+s+o>=n&&this._fetchNext(),i<=o&&this._fetchPrevious()}checkPosition(){this._checkPosition(!1)}_listenScroll(){this._onScrollFn=debounce(this.checkPosition.bind(this),100),this._container.on("scroll",this._onScrollFn),this.checkPosition()}_onClick(t){const e=this._options.onClick;if(!e||!t.target)return;let i;const n=t.target;i=n.parentElement===this._container.get(0)?n:$(n).parentsUntil(this._container.get(0)).get(-1);let s=-1;for(let t=this._itemNodes.length-1;t>=0;t--)if(this._itemNodes[t]===i){s=t;break}-1!==s&&e.call(this,{domEvent:t,itemNode:this._itemNodes[s],itemData:assignProps({},this._itemList[s])})}_listenClick(){this._container.on("click",this._onClick.bind(this))}_setAndRenderState(t,e,i,n){if(this._stateFlags[t][i]===e)return;this._stateFlags[t][i]=e;const s=this._stateNodes[t];if(e){const e=this._options.renderer,o=e[t];if(o){const t=s[i]=o.call(e,i,n);t&&(i===RenderPosition.Head?this._container.prepend(t):this._container.append(t))}}else{const t=s[i];t&&(s[i]=null,$(t).remove())}}_keepView(t){const e=this._container.get(0),i=e.scrollTop,n=e.getBoundingClientRect().top;let s,o=0,r=-1;for(;(s=this._itemNodes[++r])&&(s=this._itemNodes[r],o=s.getBoundingClientRect().top,!(o-n>=0)););if(t(),!s)return;const d=(s.parentNode?s.getBoundingClientRect().top:0)-o;d&&this._container.scrollTop(i+d)}_fetch(t,e,i){return __awaiter(this,void 0,void 0,(function*(){const n=this._stateFlags;if(this.__isLoading||n.renderBoundary[t])return;let s,o;this._keepView((()=>{this._setAndRenderState("renderLoading",!0,t)})),this.__isLoading=!0;try{s=yield e()}catch(t){o=t}finally{this.__isLoading=!1}o?this._keepView((()=>{this._setAndRenderState("renderLoading",!1,t),this._setAndRenderState("renderError",!0,t)})):null!=s&&s.length?(i(s),setTimeout((()=>{this._checkPosition(!0)}),0)):this._keepView((()=>{this._setAndRenderState("renderLoading",!1,t),this._setAndRenderState("renderBoundary",!0,t)}))}))}_updateAndRenderPrevious(t){const e=this._itemList.length+t.length-this._maxItemCount;e>0&&(this._itemList.splice(this._itemList.length-e,e),$(this._itemNodes.splice(this._itemNodes.length-e,e)).remove(),this._setAndRenderState("renderBoundary",!1,RenderPosition.Foot)),this._itemList=t.concat(this._itemList);const i=this._options.renderer.renderItems(t);this._keepView((()=>{$(this._itemNodes[0]).before(i)})),this._itemNodes=toArray(i).concat(this._itemNodes)}_fetchPrevious(){return __awaiter(this,void 0,void 0,(function*(){return this._fetch(RenderPosition.Head,(()=>this._options.dataSource.loadPreviousData(this._itemList[0][this._options.itemKey])),this._updateAndRenderPrevious.bind(this))}))}_updateAndRenderNext(t){const e=this._itemList.length+t.length-this._maxItemCount;if(e>0){this._itemList.splice(0,e);const t=$(this._itemNodes.splice(0,e));this._keepView((()=>{this._setAndRenderState("renderBoundary",!1,RenderPosition.Head),t.remove()}))}mergeArray(this._itemList,t);const i=this._options.renderer.renderItems(t);$(this._itemNodes[this._itemNodes.length-1]).after(i),mergeArray(this._itemNodes,i)}_fetchNext(){return __awaiter(this,void 0,void 0,(function*(){return this._fetch(RenderPosition.Foot,(()=>{const t=this._itemList[this._itemList.length-1];return this._options.dataSource.loadNextData(t[this._options.itemKey])}),this._updateAndRenderNext.bind(this))}))}updateItem(t){const e=this._options.itemKey;let i=-1;for(let n=this._itemList.length-1;n>=0;n--)if(this._itemList[n][e]===t[e]){i=n;break}if(-1===i)return!1;this._itemList[i]=t;const n=this._options.renderer.renderItems([t])[0];return this._keepView((()=>{$(this._itemNodes[i]).replaceWith(n)})),this._itemNodes[i]=n,!0}_shouldKeepDefaultView(){if(!this._itemNodes.length)return!1;const t=this._container.get(0),e=t.getBoundingClientRect().top,i=t.clientHeight;if("head"===this._options.defaultView){const t=this._itemNodes[0].getBoundingClientRect().top-e;return t>=0||-t<=.1*i}if("foot"===this._options.defaultView){const t=this._itemNodes[this._itemNodes.length-1].getBoundingClientRect().bottom-e;return t<i||t-i<=.1*i}return!1}addBoundaryItems(t,e,i){if(!0!==this._stateFlags.renderBoundary[e])return!1;const n=this._shouldKeepDefaultView();if(e===RenderPosition.Head)this._updateAndRenderPrevious(t);else{if(e!==RenderPosition.Foot)throw new Error('"position" must be "RenderPosition.Head" or "RenderPosition.Foot".');this._updateAndRenderNext(t)}if(i&&n)switch(this._options.defaultView){case"head":this.scrollToHead();break;case"foot":this.scrollToFoot()}return!0}}