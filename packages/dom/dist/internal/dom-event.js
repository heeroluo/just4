import{hasOwnProp}from"@just4/util/object";import{isArrayLike}from"@just4/util/array";import{isNode,isWindow,splitBySpace}from"./dom-base";import{matchesSelector}from"../selector";import{createDataSpace}from"./dom-data";import{EventWrap}from"../event-wrap";const fixEventType=function(){const e=["o","moz","ms","webkit"],t=Object.create(null),n=document.documentElement;return["TransitionEnd","AnimationStart","AnimationIteration","AnimationEnd","fullscreenchange","fullscreenerror"].forEach((function(o){const r=o.toLowerCase();"on"+r in n||e.some((function(e){if("on"+e+r in n)return t[r]=e+o,!0}))})),function(e){return null!=e&&t[e]?t[e]:e}}(),listenerManager=function(){const e=createDataSpace({onClone:function(e){this.keys(e).forEach((function(n){e.addEventListener(n,t,!1)}))}});function t(t){const n=new EventWrap(t,this),o=n.type,r=e.getData(n.currentTarget,o);r&&r.forEach((function(e){let t;const o=n.target;if(e.delegator&&isNode(o)){if(t=function(e,t){let n=e.target;for(;n&&n!==e.currentTarget;){if(matchesSelector(n,t))return n;n=n.parentNode}}(n,e.delegator),!t)return}else t=n.currentTarget;!1===e.handler.call(t,n)&&n.preventDefault()}))}return{add(n,o,r){let i=e.getData(n,o);i||(i=[],e.setData(n,o,i),n.addEventListener(o,t,!1)),i.push(r)},remove(n,o,r,i){if(o&&(r||i)){const t=e.getData(n,o);if(!t)return;if(function(e,t,n){for(let o=e.length-1;o>=0;o--)n&&e[o].handler!==n||t&&t!==e[o].delegator||e.splice(o,1)}(t,r,i),t.length)return}if(o)return e.removeData(n,o),void n.removeEventListener(o,t,!1);e.keys(n).forEach((function(e){n.removeEventListener(e,t,!1)})),e.clearData(n)}}}();function ifSupportsEvent(e,t){if(isArrayLike(e)){const n=e;for(let e=0;e<n.length;e++)ifSupportsEvent(n[e],t)}else null!=e&&"function"==typeof e.addEventListener&&t(e)}export function onEvent(e,t,n,o){const r=splitBySpace(t).map(fixEventType);r.length&&o&&ifSupportsEvent(e,(function(e){r.forEach((function(t){listenerManager.add(e,t,{handler:o,delegator:n})}))}))}export function offEvent(e,t,n,o){const r=splitBySpace(t).map(fixEventType);ifSupportsEvent(e,(function(e){r.length?r.forEach((function(t){listenerManager.remove(e,t,n,o)})):listenerManager.remove(e)}))}const shouldCallEventMethod={focus:e=>/^(?:input|select|textarea|button)$/i.test(e.nodeName),blur:e=>null!=e.ownerDocument&&e.ownerDocument.activeElement===e,reset:e=>"FORM"===e.nodeName,submit:e=>"FORM"===e.nodeName,click:()=>!0};export function triggerEvent(e,t){t=fixEventType(t),ifSupportsEvent(e,(function(e){if(isNode(e)&&"function"==typeof e[t]&&hasOwnProp(shouldCallEventMethod,t)&&shouldCallEventMethod[t](e))return void e[t]();let n=null;if(isNode(e)?n=e.ownerDocument:isWindow(e)&&(n=e.document),n){const o=n.createEvent("Event");o.initEvent(t,!0,!0),e.dispatchEvent(o)}}))}